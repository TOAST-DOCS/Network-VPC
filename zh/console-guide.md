## Network > VPC >控制台的使用指南

在控制台对 VPC进行操作时所需内容，下文将对此进行说明。

## VPC

VPC中可以划分多个子网，因此在使用的时候，应设定足够大的网络地址。划分VPC网络的方法，可以参考[CIDR Notation](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing)。所有VPC应属于[私有网络](https://en.wikipedia.org/wiki/Private_network)的下述3个地址段中，本地链接地址段无法使用。同时，划分应至少大于24bit-256个的网络地址的网络地址段。

###私有网络

RFC1918 | IP地址段 | 可以使用的地址个数
-------- | ---------- | -----------------
24bit block | 10.0.0.0/8 | 16,777,216
20bit block | 172.16.0.0/12 | 1,047,576
16bit block | 192.168.0.0/16 | 65,536

###本地链接地址段

169.254.0.0/16的65,536个IP地址，属于本地地址，不可使用。

###示例

例 | 是否可以使用
-------- | ----------
10.0.0.0/8 | 可以使用。
10.0.0.0/16 |可以使用。
10.0.0.0/24 |可以使用。
10.0.0.0/28 |不可使用。范围过小。
172.16.0.0/16 |可以使用。
172.16.0.0/8 | 不可使用。已超出可以使用的范围。
192.168.0.0/16 |可以使用。将被指定为基本使用范围。
192.168.0.0/24 |可以使用。
192.253.0.0/24 |可以使用。已超出可以使用的范围。

<br>


如果使用了Compute 和 Network的商品，以下项目将会自动生成一些默认配置。

项目 | 名称 | 概要
-------- | ---------- | --------------
VPC | Default Network | 自动创建1个192.168.0.0/16范围的 VPC。
子网 | Default Network | 自动创建1个192.168.0.0/24范围的子网。
路由表（routing table） | vpc-[id] | 自动创建1条含有部分VPC ID名称的路由表。
NAT网关 | ig-[id] | 自动创建1个含有部分路由表ID名称的NAT网关。
安全组（group）| default | 自动创建1个名为default的安全组。

添加VPC时，以下项目将会自动生成一些默认配置。

项目 | 名称 | 概要
-------- | ---------- | --------------
VPC | 自定义的名称 | 创建1个自定义范围的VPC。
子网 | - | 不会自动创建
路由表 | vpc-[id] | 自动创建1个含有部分VPC ID名称的路由表。
NAT网关 | - | 不会自动创建，所以需要自行创建和绑定。
安全组 | - | 不会自动创建。

VPC与各项目之间的使用配额(quota)如下：

项目 | 最大值
-------- | ----------
VPC | 3
子网 | 10
互联网网关 | 3 
Floating IP | 不限制
路由表 | 10 
Peering | 不限制



> [参考]
如果想删除VPC，则VPC内创建的所有子网应为未使用的状态。如果删除 VPC，则里面的子网、路由表、NAT网关一并删除。

* VPC之间是完全隔离的，不能进行相互通讯。

* VPC为私有网络，因此无法在外部互联网上直接访问。

* VPC内的所有实例，无法使用VLAN。

* 对VPC不支持跨地域（region）通讯。即一个VPC中的多个实例，只能是同一个地域。

* 没有NAT网关的情况下， VPC内的所有实例不能连接到外部互联网。

* 以下的情况可能不会被预先通知，”Broadcast, Multicast, Unknown Unicast”过多的情况下，网络可能会被切断。


##子网

VPC可以划分多个子网，构成几个小型网络。但是，子网应属于VPC地址范围内。例如， 192.168.0.0/16的情况下，可使用 192.168.0.0~192.168.255.255为止共 65536个网络地址。同时，最小的子网为30bit-4个网络地址，且无法比这个小。子网也与 VPC一样，使用CIDR的划分方法。

如果创建子网则网关的IP地址将被自动指定，并且无法对其进行更改。而且将被自动添加到所在VPC的路由表中。

> [参考]
如果想要删除子网，只有子网中不包含实例或负载均衡等设备的空子网时，才能删除。

* 创建实例后，将为其自动分配一个已选定子网中的IP地址(固定 IP(fixed IP)).

* 实例启动时，将通过DHCP自动获取IP地址。

* 子网的地址范围无法更改。

* 在同一个VPC内，子网范围不能重复或重叠。

* 不同VPC中，子网范围可以重复或重叠。

* 如果不是系统自动分配给实例的MAC地址，将无法使用网络。所以，在实例上VPN服务也无法使用。

* 如果一个实例需要连接多个子网时，应在实例内的OS中设定精确、正确的路由。

* 同一个VPC内的两个子网不是完全隔离的。请使用安全组规则来保护实例。

* 子网支持跨不同可用区的本地通讯（相同子网下的多个实例，可以在不同的可用区中）。本地通信不收取费用。


##NAT网关

NAT网关可与路由表连接。VPC私有网络的正常无法进行外部通讯，但使用NAT网关可以访问访问外部互联网。要连接到外部互联网，各实例应将“默认网关”设定为子网的网关地址，TOAST将对此进行自动处理。创建NAT网关时，应选择“外部网络”，但是当前在 TOAST中，目前只能选择“public_network”。

* 创建实例或者VPC网络连接到外部互联网时，NAT网管将自动进行分配，并且无法进行变更。

* 外部无法通过NAT网关地址访问内部实例。

* 外部流入到NAT网关地址的异常流量将被阻止。

* 连接到互联网的实例的上行流量，费用将按照实际使用量来收取。

* 对于实例之间的本地内部通信流量，不收取费用。


##弹性IP

创建实例后，系统将为其自动分配一个已选定子网中的IP地址。该地址为私有网络地址，因此在互联网上不能访问该IP地址。所以，如果想在外部直接访问实例，则应使用在外部可以访问的 IP 地址。弹性IP是为了在互联网上直接访问实例而使用的。弹性IP是公网IP，绑定实例后，将会以1对1方式映射到实例的私网网卡上，因此在互联网上可以进行直接访问。详见 [概述]。要创建弹性IP，应选择“外部网络”，但在 TOAST中，目前只能选择 “public_network”。

> [参考] 为了给实例绑定弹性IP，包含该实例的子网应连接路由表，<br>
>并该路由表通过NAT网关连接到互联网的情况下，方能执行”连接”操作。

* 弹性IP在创建成功的同时开始收费。直到删除之前为止将持续收费。（与实例是否无关）

* 就算实例绑定了弹性IP，实例本身的私网IP（Fixed IP）不会发生变更。

* 向互联网方向的上行流量，则将收取费用。

* 相同 VPC内的两个实例，使用弹性IP进行通信，费用按照使用量来收取。

> [参考] 相同 VPC 内的两个实例，使用私网IP(fixed IP)进行本地通信，则不收取费用。


##安全组

安全组用于保护实例免受其他流量影响。使用允许指定的流量并阻止其余流量的“正面安全模型(positive security model)”。

首次开始服务时，创建一个默认安全组，阻止所有流入的流量。因此“ping”、“ssh”等服务也无法使用，设置所需规则后方可使用。统一应用于使用浮动IP的外部访问及使用私有IP的内部访问。

可为实例设置多个安全组。若补充创建安全组，添加多个规则并在实例中完成设置，则设置的所有安全组规则应用于实例。

例如，名为“CONN”的安全组中有称为“收信TCP PORT 22”、“收信TCP PORT 23”的规则，名为“WEB”的安全组中有称为“收信TCP PORT 80”、“收信TCP PORT 8080”的规则时，若为一个实例设置“CONN”、“WEB”两个安全组，则同时应用四个规则，且相应服务均可使用。


| 项目        | 说明                                                         |
| ----------- | ------------------------------------------------------------ |
| 方向        | 收信表示流入实例的方向。送信表示从实例流出的方向。|
| Ether Type  | 表示EtherType IP的版本。可指定IPv4, IPv6。|
| IP协议 | 可指定特定协议或指定全部。      |
| 端口范围   | L4协议的情况下可指定端口的范围。         |
| 远程        | 可指定安全组或IP地址范围。若规则的方向为“送信”，则目的地为远程，若为“收信”，则出发地为远程。按照规则的方向比较流量的出发地和目的地，若指定安全组，则比较是否为指定安全组所属的实例的IP，选择CIDR指定IP地址或范围的情况下，则比较是否为设置的IP地址或范围。|

安全组以“stateful”运行，因此按照规则连接一次的会话，即使没有反向的规则也会被允许。

例如，若流向实例的TCP 80的第一个数据包按照“收信TCP PORT 80”规则通过，则从实例以TCP 80为出发地传送的数据包不被阻止。

但，若在未流入符合一定时间规则的数据包时就结束会话，则反向的数据包也被阻止。

默认安全组中设置了从实例流出的所有流量的规则。若不删除该规则，则从实例开始的会话将全部被允许。

* 规则最好不要一项一项的添加规则，指定范围的方式更加有效。

* 随着规则条目数量的增加，可能会有性能下降现象。

* 会话状态不符的流量，可能会被断开。

* 流入与流出网络路径不同的非对称流量将被阻止。

* 可以自定义列表中没有的协议规则。详见 [Well-known port](https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers)。

##路由表

路由表与VPC一同生成，并且VPC被删除时路由表也将被删除。一个VPC可以生成多张路由表，如果不是默认路由表，则可以进行删除。子网至少要连接到一个路由表，而且多个路由表不能共享一个NAT网关。

在指定路由表条目的时候，详情页面有扼要信息，**Routes**tap上可添加路由条目。

> [参考]
添加路由条目时，必须指定VPC内可到达的网络地址范围，才能添加。超出范围将会添加失败。

* 被包含于路由表的子网网关将被自动添加。

* 无法删除”默认路由表”。删除VPC时，将会一同被删除

* 无法从路由条目中删除子网网关与NAT网关。

* 路由表与NAT网关断开连接，则互联网连接也被断开。



##Peering

Peering是为了两个VPC之间的内网相互通讯。一般情况下VPC之间都是隔离的，无法相互进行通讯，虽然可利用弹性IP来实现通讯，但是弹性IP的流量，将被收取费用。因此我们提供了实现两个VPC之间内网通讯的功能，将此称为Peering。

> [参考] Peering实现两个不同的VPC通讯。但是不支持三方交叉的方式实现VPC间的通讯。例： A <-> B Peering ，B <-> C Peering，A与 C不会自动的Peering。

* 两个VPC网络内的IP 地址段重叠时，则无法使用。<br>
如果创建Peering时，两个VPC的IP地址段有重叠的情况，Peering创建将会失败。

* 未连接到”默认路由表”的子网，将无法通信，与IP地址段的范围大小无关。

* Peering创建成功的同时，将发生费用。

* Peering虽然没有配额限制，但将会消耗一个子网配额。

