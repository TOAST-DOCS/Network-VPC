## Network > VPC > コンソール使用ガイド

この文書ではコンソールでVPCを扱う時に必要な内容を記述しています。

## VPC

VPCは複数のサブネットを持つことができるため、サブネットを分割して使用する場合、十分な大きさのネットワークを設定する必要があります。VPCネットワークは[CIDR 表記](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing)を使用して記述できます。全てのVPCは[プライベートネットワーク](https://en.wikipedia.org/wiki/Private_network)を構成できる下記3つのアドレス領域に存在する必要があり、リンクローカルアドレスは使用できません。また少なくとも24bit-256個より大きなネットワーク領域を指定する必要があります。

### プライベートネットワーク

RFC1918 | IPアドレス領域 | 使用可能なアドレス個数
-------- | ---------- | -----------------
24bit block | 10.0.0.0/8 | 16,777,216
20bit block | 172.16.0.0/12 | 1,047,576
16bit block | 192.168.0.0/16 | 65,536

### リンクローカルアドレス

169.254.0.0/16に含まれる65,536個のIPアドレスは使用できません。

### 例

例 | 使用可否
-------- | ---------- 
10.0.0.0/8 | 使用できます。
10.0.0.0/16 | 使用できます。
10.0.0.0/24 | 使用できます。
10.0.0.0/28 | 使用できません。範囲が小さすぎます。
172.16.0.0/16 | 使用できます。
172.16.0.0/8 | 使用できません。使用可能な範囲を超えました。
192.168.0.0/16 | 使用できます。基本使用範囲に指定されます。
192.168.0.0/24 | 使用できます。
192.253.0.0/24 | 使用できません。使用可能な範囲を超えました。 

<br>


最初にComputeとNetwork商品を使用すると、下記のような項目を自動的に構成します。

項目 | 名前 | 要約
-------- | ---------- | --------------
VPC | Default Network | 192.168.0.0/16範囲のVPC 1個が作成されます。
サブネット | Default Network | 192.168.0.0/24範囲のサブネット1個が作成されます。
ルーティングテーブル | vpc-[id] | VPC IDの一部を名前に持つルーティングテーブル1個が作成されます。
インターネットゲートウェイ | ig-[id] | ルーティングテーブルIDの一部を名前に持つインターネットゲートウェイ1個が作成されます。
セキュリティーグループ | default | defaultという名前を持つセキュリティーグループ1個が作成されます。

初期構成ではなく、VPCを追加する場合は下記の項目を構成します。

項目 | 名前 | 要約
-------- | ---------- | --------------
VPC | 指定した名前 | 指定した範囲のVPC 1個が作成されます。
サブネット | - | 作成されません。
ルーティングテーブル | vpc-[id] | VPC IDの一部の名前を持つルーティングテーブル1個が作成されます。
インターネットゲートウェイ | - | 生成されないため、別途生成後に接続する必要があります。
セキュリティーグループ | - | 追加で生成されません。

VPCと各項目で利用可能な上限値は下記のとおりです。

項目 | 最大値
-------- | ---------- 
VPC | 3
サブネット | VPCあたり10 
インターネットゲートウェイ | 3
Floating IP | 制限なし
ルーティングテーブル | VPCあたり10 
リルート | ルーティングテーブルあたり10



> [参考]
VPCを削除するには、サブネットを全て削除できる状態でのみ削除可能です。その場合はサブネット、ルーティングテーブル、インターネットゲートウェイも一緒に削除されます。

* VPCは他のVPCと完全に隔離されているため、トラフィック上の安全性が保たれます。

* VPCはプライベートネットワークのため、インターネットから直接アクセスできません。

* VPC内の全ての機器においてVLANの構築はできません

* 異なるリージョンを跨ぐトラフィックについてはローカル通信を提供しません。

* インターネットゲートウェイの設定をしないと、 VPC内の全てのインスタンスがインターネットに接続されません。

* 過度に転送される「ブロードキャスト、マルチキャスト、Unknownユニキャスト」は予告なく遮断されることがあります。

* **プライベートIP DNS**機能の使用有無を指定できます。
  * 同じVPC内の通信のみ使用できます。
  * プライベートIP DNS機能を使用する場合は、VPCに属するインスタンスのネームサーバーをプライベートDNSポートに再設定する必要があります。
    * インスタンスを再起動すると、インスタンスのネームサーバーがプライベートDNSポートIPに設定されます。
    * 再起動せずにネームサーバーを変更するには、インスタンスに接続してネームサーバーをプライベートDNSポートIPに指定する必要があります。各OSのネームサーバーを設定する方法に従って変更を行います。

> [参考]プライベートDNSポート
> * プライベートIP DNSを設定したり、VPCを初めてZoneに接続すると、VPC内にプライベートDNSポートが作成されます。
> * プライベートIP DNSを設定せず、すべてのZoneと接続が解除されたVPCは、プライベートDNSポートが削除されます。
> * プライベートIP DNSを設定せずにすべてのZoneと接続を解除した後、再接続したVPCは、プライベートDNSポートが変更される場合があります。
> * プライベートDNSポートが作成/変更/削除される場合、これを適用するためにネームサーバーのリセットを行う必要があります。
>   * インスタンスを再起動すると、ネームサーバーがリセットされます。
>   * 再起動せずにネームサーバーを変更するには、インスタンスに接続してネームサーバーを変更する必要があります。各OSのネームサーバーを設定する方法に従って変更を行います。
> * プライベートDNSポートを適用するためにインスタンスを再起動した場合、その後、そのVPCに追加的に他のZoneを接続したり、プライベートIP DNS設定を変更する場合にインスタンスを再起動する必要はありません。


## サブネット

仮想ネットワーク(VPC)にリソースを接続してIPを付与するためには、一つ以上のサブネットを作成する必要があります。

サブネットはIP割り当てプールを管理し、DHCPサーバーを運営します。IP割り当てが必要なリソースに使用可能なIPを割り当て、割り当てたIPをDHCPで取得できるようにDHCPサーバーに登録します。

基本的に同じVPCのすべてのサブネット内のリソースは、特別な設定なしにルーティングテーブルを経由してアクセスが可能です。VPCと違って完全に隔離されないため、セキュリティグループ、ACLなどを利用したアクセス制御が必要な場合があります。

> [参考]
> 異なるルーティングテーブルに接続されたサブネットのリソースも相互にアクセスできます。

サブネットリストでサブネットを選択すると、リストの下部に以下の情報を確認できます。

### サブネットの基本情報
サブネット名、UUID、CIDR、作成日などの基本的な情報と、サブネットのゲートウェイIPおよびリソースに割り当てることができる利用可能なIP数を確認できます。

> [参考]
> サブネットの可用IP数は、サブネットの既存のリソースに割り当てるIP以外に、以下のIPを除いた数です。
> 例えば、サブネットのCIDRが`192.168.0.0/24`の場合
> * 192.168.0.0 - ネットワークアドレス
> * 192.168.0.1 - ゲートウェイアドレス。サブネットが作成されると、VPCの**基本ルーティングテーブル**に自動的に接続され、この時、最初のIPがゲートウェイアドレスとして割り当てられます。
> * 192.168.0.2 - DHCP Serverアドレスまたはインターネットゲートウェイに接続するSNAT用IP
> * 192.168.0.3 - DHCP Serverアドレスまたはインターネットゲートウェイに接続するSNAT用IP
> * 192.168.0.255 - Broadcastアドレス
>
> インターネットゲートウェイに接続されるSNAT用IPは、サブネットが接続されたルーティングテーブルにインターネットゲートウェイ接続がある場合に割り当てられ、ルーティングテーブルとインターネットゲートウェイの接続時点によって、`192.168.0.3`以外のIPが割り当てられることもあります。

### サブネット接続情報
サブネットからIPを割り当てられたリソースのリストです。リソースのタイプ、ID、割り当てられたIPと、リソースにフローティングIPを接続した場合、そのFloating IPを確認できます。

### サブネットの静的ルート
サブネットの**静的ルート**設定を利用して、サブネット内のインスタンスが起動時にインスタンス内のルーティングテーブルに設定すべきルーティングルールを伝達できます。

* **静的ルート**に登録したルーティングルールは、インスタンスがリクエストしたDHCPリクエストに対するレスポンスの'classless-static-routes'オプションに含まれて送信され、インスタンスで動作しているDHCPクライアントでこのオプションの内容をルーティングテーブルに登録します。

* 'classless-static-routes'オプションの反映方式は、インスタンスで実行しているOSの種類、ディストリビューションまたはDHCPクライアントのバージョンによって異なりますが、一般的に、インスタンスの起動などDHCPクライアントが初めて起動されたときに反映され、DHCPレンタル更新時には反映されません。したがって、サブネットの**静的ルート**を編集したとき、実行中のインスタンスには変更内容がすぐに適用されない場合がありますので、可能な限り実行中の対象インスタンスを再起動することを推奨します。

* **静的ルート**はルーティングするパケットの目的地CIDRと、対象パケットを伝達するゲートウェイ情報で構成されます。<br>CIDRが"0.0.0.0/0"の静的ルートを作成すると、インスタンスのデフォルトゲートウェイをサブネットのゲートウェイ以外のIPに変更できます。<br>ゲートウェイはルーティングテーブルの**ルート**とは異なり、テキストで入力し、サブネット内にまだ割り当てられていないIPも指定できます。

### サブネットの作成
次の情報を入力してサブネットを作成します。

* 名前：サブネットの名前を入力します。
* VPC：サブネットを作成するVPCを選択します。
* IPバージョン：サブネットで使用するIPバージョンを選択します。現在、IPv4のみをサポートしています。
* CIDR：サブネットのアドレス範囲を入力します。
  * サブネットのアドレス範囲はVPCアドレス範囲に含まれている必要があり、最小範囲は28bitです。
  * 同じVPC内の他のサブネットとアドレス範囲が重ならないようにしてください。
  * サブネットが作成された後は、範囲を変更できません。

> [参考]
> サブネットはVPCごとに最大10個まで作成できます。 
> 単一VPC内で11個以上のサブネットの作成が必要な場合[サポート](https://www.nhncloud.com/kr/support/inquiry)にお問い合わせください。 

### サブネットの修正
サブネットの名前を変更できます。 

### サブネットの削除
選択したサブネットを削除します。サブネットの削除は、インスタンスやロードバランサーなど、サブネットにIPを割り当てられているリソースが含まれていない場合にのみ可能です。


## ルーティングテーブル

ルーティングテーブルはVPCと同時に生成され、VPCが削除されると一緒に削除されます。ルーティングテーブルはVPCに複数生成することができ、基本ルーティングテーブルでなければ明示的に削除できます。サブネットは少なくとも1つのルーティングテーブルに接続されている必要があり、複数のルーティングテーブルが1つのインターネットゲートウェイを共有できません。

ルーティングテーブルリストを指定する場合、詳細画面に要約された情報が表記され、 "ルート"タブを利用して経路を追加できます。

> [参考]
経路を追加する場合、VPC内に到達可能な領域を指定すると追加できます。それ以外は失敗メッセージが発生します。

* ルーティングテーブルに含まれるサブネットのゲートウェイは自動的に追加されます。

* "基本ルーティングテーブル"は削除できません。VPCを削除すると削除されます。

* サブネットのゲートウェイとインターネットゲートウェイはルートリストから削除できません。

* ルーティングテーブルとインターネットゲートウェイの接続が切れると、インターネット接続が切断されます。

* ルーティングテーブルのルートを作成して特定CIDRに対してゲートウェイを指定できます。ルートを誤って設定すると通信が切断される場合があるため注意してください。

ルーティングテーブルは、作成される場所に応じて「分散型ルーティング(DVR)」方式と「中央集中型ルーティング(CVR)」方式で作成できます。

* 分散型ルーティング(DVR)方式

    * ルーティングテーブルに接続されているサブネットに含まれるインスタンスが配置されているハイパーバイザごとにルーティングテーブルが作成される方式です。ルーティングテーブルが使用される場所に均等に分散されるため、安定性と高可用性が得られます。

* 中央集中型ルーティング(CVR)方式

    * 中央に1つのルーティングテーブルが作成され、ルーティングテーブルに接続されたサブネットに含まれるインスタンスのトラフィックが1つのルーティングテーブルに集中する方式です。<br>ゲートウェイやファイアウォールなど、1つの地点を通じてトラフィックを制御する場合に使われます。

分散型ルーティング(DVR)方式は、NHN Cloudが基本的に提供する方式です。安定性、高可用性およびトラフィック分散の利点があり、特別な場合を除いて分散型ルーティング(DVR)方式を使用することを推奨します。

ルーティングテーブルの方式を変更することも可能です。変更時にルーティングテーブルを再構成し、完了するまで約1分間、外部通信およびサブネット間の通信が切断されるため注意してください。
